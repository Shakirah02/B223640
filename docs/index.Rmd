---
title: "How do prescription patterns for SSRIs and SNRIs vary between exam and non-exam periods in university health board regions from 2019 to 2023, and what trends are observed over this period? "
author: "Syakirah"
date: "2024-11-01"
output: html_document
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(message=FALSE, warnings=FALSE, echo = TRUE)
#remove.packages("rlang")
#install.packages("rlang", dependencies = TRUE)
# packageVersion("rlang")
# install.packages("sf")
# install.packages(ggExtra)
```


```{r}
library(tidyverse)
library(janitor) # cleaning data
library(gt) # tables
library(here) # directory structure (will be useful later)
library(patchwork)
library(sf)
# library(rlang)
```

Read the population data and Health Board names datasets, clean names and select the relevant columns
```{r}
 population_data <- read_csv("C:/Data_Science/B223640/data/UV103_age_health_board_census.csv", skip = 10) %>%
  # Rename the last column to avoid the messy name in column 6
  # and to match column names with the prescription dataset
  rename(hb_name = "Health Board Area 2019",
         hb_population = Count) %>% 
  # filter the data so that we get the population of the entire health board
  filter(Age == "All people" & Sex == "All people") %>% 
  # select only the relevant columns
  select(hb_name, hb_population) %>% 
  # change health board names so they match the prescription data
  mutate(hb_name = paste("NHS", hb_name)) %>% 
  arrange(desc(hb_population))


HB_names <- read_csv("C:/Data_Science/B223640/data/HB_names.csv") %>%
  clean_names() %>% 
  select(hb, hb_name) %>% 
  rename(hbt = hb)
```

loading the age data and finding the population number of ages 18-25(typical age of university students) for each health board. Join with the population data frame to find the percentage of people in the age group within each Healthboard.

```{r}

library(dplyr)

age_data <- read.csv("C:/Data_Science/B223640/data/UV103_age_health_board_census.csv", skip = 10)

age_data <- age_data %>% 
  filter(str_detect(Age, "18|19|20|21|22|23|24|25")) %>% 
  rename(hb_name = Health.Board.Area.2019) %>% 
  mutate(hb_name = paste("NHS", hb_name))%>% 
  group_by(hb_name) %>% 
  summarise(totalpeople = sum(Count)) %>% 
  left_join(population_data) %>% 
  mutate("percentage" = totalpeople*100/hb_population)
```

Loading the exam and nonexam season datasets 

```{r}
library(tidyverse)

# List all CSV files in the "summer_20-23" folder
examfiles <- list.files("C:/Data_Science/B223640/data/examszn_19-23", pattern = "csv", full.names = TRUE)

# Define column types explicitly
column_types <- cols(
  HBT = col_character(),
  DMDCode = col_character(), # Ensures DMDCode is read as character in all files
  BNFItemCode = col_character(),
  BNFItemDescription = col_character(),
  PrescribedType = col_character(),
  GPPractice = col_double(),
  NumberOfPaidItems = col_double(),
  PaidQuantity = col_double(),
  GrossIngredientCost = col_double(),
  PaidDateMonth = col_double()
)

# Load and combine the files into one data frame
examszndata <- examfiles %>% 
  map_dfr(~read_csv(., col_types = column_types))

# List all winter CSV files in the "winter_20-23" folder
nonexamfiles <- list.files("C:/Data_Science/B223640/data/nonexamszn_19-23", pattern = "csv", full.names = TRUE)
# Load and combine the files into one data frame
nonexamszndata <- nonexamfiles %>% 
  map_dfr(~read_csv(., col_types = column_types))
```

joining the the exam and exam season datasets with the HB_names and population_data sets and filter for the SSRIs and SNRIs commonly prescribed for exam-stress related anxiety and depression.
```{r}
examszndata1 <- examszndata %>%
  clean_names() %>% 
  full_join(HB_names) %>%
  full_join(population_data) %>%  
  filter(str_detect(bnf_item_description, "ESCITALOPRAM|SERTRALINE|FLUOXETINE|VENLAFAXINE|FLUVOXAMINE|PAROXETINE|CITALOPRAM|RITALIN|CONCERTA"))%>%
  filter(str_detect(hb_name, "Lothian|Grampian|Greater Glasgow and Clyde|Tayside|Fife|Forth Valley")) %>% 
  group_by(hb_name, bnf_item_description, hb_population) %>%
  summarise(total_prescription = sum(paid_quantity)) %>% 
  mutate("per_person" =  total_prescription/hb_population)

nonexamszndata1 <- nonexamszndata %>%
  clean_names() %>% 
  full_join(HB_names) %>% 
  full_join(population_data) %>%  
  filter(str_detect(bnf_item_description, "ESCITALOPRAM|SERTRALINE|FLUOXETINE|VENLAFAXINE|FLUVOXAMINE|PAROXETINE|CITALOPRAM|RITALIN|CONCERTA"))%>%
   filter(str_detect(hb_name, "Lothian|Grampian|Greater Glasgow and Clyde|Tayside|Fife|Forth Valley")) %>%
  group_by(hb_name, bnf_item_description, hb_population) %>%
  summarise(total_prescription = sum(paid_quantity)) %>% 
  mutate("per_person" =  total_prescription/hb_population)

```
Pivot wider to find the individual total prescriptions of each medication for each Health Board
```{r}
library(dplyr)
library(stringr)

# Assuming your data is in a dataframe called `df`
 examszndatawide <- examszndata %>%
   clean_names() %>% 
  mutate(bnf_item_description = str_remove(bnf_item_description, "[_\\s].*")) %>% 
   full_join(HB_names) %>% 
  full_join(population_data) %>%  
  filter(str_detect(bnf_item_description, "ESCITALOPRAM|SERTRALINE|FLUOXETINE|VENLAFAXINE|FLUVOXAMINE|PAROXETINE|CITALOPRAM|RITALIN|CONCERTA"))%>%
   filter(str_detect(hb_name, "Lothian|Grampian|Greater Glasgow and Clyde|Tayside|Fife|Forth Valley")) %>%
  group_by(hb_name, bnf_item_description, hb_population) %>%
  summarise(total_prescription = sum(paid_quantity)) %>% 
   pivot_wider(
     names_from = bnf_item_description,
     values_from = total_prescription,
     values_fill = list(total_prescription = 0)
   ) %>% 
   left_join(age_data) %>% 
   mutate(average_prescription = rowMeans(across(CITALOPRAM:VENLAFAXINE), na.rm = TRUE)) %>% 
   arrange(desc(average_prescription)) %>% 
   gt()
 

 
nonexamszndatawide <- nonexamszndata %>%
   clean_names() %>% 
  mutate(bnf_item_description = str_remove(bnf_item_description, "[_\\s].*")) %>% 
   full_join(HB_names) %>% 
  full_join(population_data) %>%  
  filter(str_detect(bnf_item_description, "ESCITALOPRAM|SERTRALINE|FLUOXETINE|VENLAFAXINE|FLUVOXAMINE|PAROXETINE|CITALOPRAM|RITALIN|CONCERTA"))%>%
   filter(str_detect(hb_name, "Lothian|Grampian|Greater Glasgow and Clyde|Tayside|Fife|Forth Valley")) %>%
  group_by(hb_name, bnf_item_description, hb_population) %>%
  summarise(total_prescription = sum(paid_quantity)) %>% 
   pivot_wider(
     names_from = bnf_item_description,
     values_from = total_prescription,
     values_fill = list(total_prescription = 0)
   ) %>% left_join(age_data) %>% 
  mutate(average_prescription = rowMeans(across(CITALOPRAM:VENLAFAXINE), na.rm = TRUE)) %>% 
   arrange(desc(average_prescription))
```


```{r}
# Assuming both dataframes have the same columns and are keyed by `hb_name`
# library(dplyr)

# Join the examdata and nonexamdata on hb_name
# combined_data <- examszndata %>%
#   inner_join(nonexamszndata, by = "hb_name", suffix = c("_exam", "_nonexam"))
# 
# # Calculate the difference for each drug
# difference_data <- combined_data %>%
#   mutate(across(ends_with("_exam"), 
#                 ~ . - get(gsub("_exam", "_nonexam", cur_column())), 
#                 .names = "diff_{.col}")) %>%
#   select(hb_name, starts_with("diff_"))
# 
# # Rename the columns to be more descriptive
# difference_data <- difference_data %>%
#   rename_with(~ gsub("diff_bnf_item_description_", "", .), starts_with("diff_"))

```

```{r}

examseasontry <- examszndata1 %>%
    mutate(bnf_item_description = str_remove(bnf_item_description, "[_\\s].*")) %>%
  full_join(age_data) %>% 
  group_by(hb_name, totalpeople, percentage, hb_population) %>% 
  summarise(total_prescription = sum(total_prescription)) %>% 
  filter(!is.na(total_prescription)) %>% 
  mutate(Season = "examseason") %>% 
  mutate(per_person = total_prescription/hb_population)

nonexamseasontry <- nonexamszndata1 %>%
    mutate(bnf_item_description = str_remove(bnf_item_description, "[_\\s].*")) %>%
  full_join(age_data) %>% 
  group_by(hb_name, totalpeople, percentage, hb_population) %>% 
  summarise(total_prescription = sum(total_prescription)) %>% 
  filter(!is.na(total_prescription)) %>% 
  mutate(Season = "nonexamseason")%>% 
  mutate(per_person = total_prescription/hb_population)

# Combine the two datasets
combined_data <- bind_rows(examseasontry, nonexamseasontry)

# Create the boxplot
ggplot(combined_data, aes(x = Season, y = total_prescription)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.5, color = "blue")
  labs(title = "Comparison of Total Prescriptions between Datasets",
       x = "Season",
       y = "Total Prescriptions") +
  theme_minimal()
  
```
Throughout 2019 to 2023 cumulatively, total prescriptions of SNRIs and SSRIs increase in the months when scottish universities have exams, but only slightly.


```
Graph of total prescriptions 
```{r}
# For exam season
combined_data %>%
  ggplot(aes(x = totalpeople, y = total_prescription, color = Season)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Adds line of best fit
  labs(title = "Total People vs. Total Prescription",
       x = "Total People",
       y = "Total Prescription",
       color = "Season") +
  theme_minimal()
```



